<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="utf-8">
<style>
body,#bg {
  padding: 0;
  margin: 0;
}
#content {
  margin: 10px 10px;
  padding: 10px 30px;
  position: absolute;
  z-index: 1;
  background-color: rgba(255,255,255,0.7);
}
#header { width: 100% }
#image, #controler {
  float: left;
  padding: 5px 5px;
}
#formula { clear: both; } 
#canvas { border: solid 2px #888; }
textarea {
  vertical-align: middle;
  font-family: "Courier";
  font-size: 14px;
  background-color: rgba(255,255,255,0.9);
}
input.ctl { width: 270px }
.caution { 
  color: red;
  font-family: "Courier";
  font-size: 14px;
  background-color: rgba(255,255,255,0.8);
}
</style>
<title>UserFilter for canvas DEMO</title>
</head>
<body>
<div id="content">
<div id="header">
<h2>UserFilter for canvas DEMO</h2>
</div>
<div id="image">
file:
<select id="file">
<option value="../ufjs/kodim01s.jpg">kodim01</option>
<option value="../ufjs/kodim08s.jpg">kodim08</option>
<option value="../ufjs/kodim22s.jpg">kodim22</option>
<option value="Lenna.jpg">Lenna</option>
<option value="128">blank: 128x128</option>
<option value="256" selected>blank: 256x256</option>
<option value="512">blank: 512x512</option>
</select>
<br>
<canvas id="canvas" width="256" height="256"></canvas><br>
</div>
<div id="controler">
controler:
<ol start="0">
  <li><input type="range" id="c0" class="ctl" min="0" max="255" value="0"><input id="m0" type="text" size="3" value="0"></li> 
  <li><input type="range" id="c1" class="ctl" min="0" max="255" value="0"><input id="m1" type="text" size="3" value="0"></li> 
  <li><input type="range" id="c2" class="ctl" min="0" max="255" value="0"><input id="m2" type="text" size="3" value="0"></li>
  <li><input type="range" id="c3" class="ctl" min="0" max="255" value="0"><input id="m3" type="text" size="3" value="0"></li>
  <li><input type="range" id="c4" class="ctl" min="0" max="255" value="0"><input id="m4" type="text" size="3" value="0"></li>
  <li><input type="range" id="c5" class="ctl" min="0" max="255" value="0"><input id="m5" type="text" size="3" value="0"></li>
  <li><input type="range" id="c6" class="ctl" min="0" max="255" value="0"><input id="m6" type="text" size="3" value="0"></li>
  <li><input type="range" id="c7" class="ctl" min="0" max="255" value="0"><input id="m7" type="text" size="3" value="0"></li>
</ol>
</div>
<div id="formula">
formula:<br>
R<textarea id="f0" cols="80" rows="2">r</textarea><span id="e0" class="caution"></span><br>
G<textarea id="f1" cols="80" rows="2">g</textarea><span id="e1" class="caution"></span><br>
B<textarea id="f2" cols="80" rows="2">b</textarea><span id="e2" class="caution"></span><br>
A<textarea id="f3" cols="80" rows="2">A</textarea><span id="e3" class="caution"></span><br>
<br>
<button id="apply">apply</button> <button id="start">start</button> <button id="stop">stop</button> <button id="popup">to PNG</button> <button id="setbg">set to background</button>
</div>
<ul>
<li>source: <a href="https://github.com/youz/ufjs/"> github.com/youz/ufjs </a></li>
<li>reference: <a href="http://gimpuserfilter.sourceforge.net/">UserFilter Plug-in for The Gimp</a></li>
</ul>
</div>
<script src="uf.co" type="coco"></script>
<script type="coco">
UFJS_DEMO = do ->
  [images, canvas, ctx, UF] = [{}]

  $ = document~getElementById

  function render (reset)
    UF.setFormula($(\f0).value, $(\f1).value, $(\f2).value, $('f3').value)
    for i to 7
      UF.controler[i] = $('c'+i).value * 1
    if reset then load_image($(\file).value)
    UF.apply(canvas)

  function load_image (file, cb)
    if !isNaN(file)
      size = file * 1
      canvas.width = canvas.height = size
      ctx.putImageData(ctx.createImageData(size, size), 0, 0)
      cb?!
    else
      if images[file]
        canvas.width = images[file].width
        canvas.height = images[file].height
        ctx.drawImage(images[file], 0, 0)
        cb?!
      else
        e = document.createElement(\img)
        e.onload = ->
          images[file] = e
          canvas.width = e.width
          canvas.height = e.height
          ctx.drawImage(e, 0, 0)
          cb?!
        ctx.save!
        ctx.shadowOffsetX = ctx.shadowOffsetY = ctx.shadowBlur = 1
        ctx.shadowColor = '#fff'
        ctx.fillText("loading:" + file, 0, 20)
        ctx.restore!
        e.src = file

  function load_from_hash
    if location.hash is not ''
      data = location.hash.substr(1).split(/:/)
      if (data.length < 13) then return
      for i to 7
        $('c'+i).value = $('m'+i).value = data[i]
      ok = true
      for i to 3
        formula = $('f'+i).value = unescape(data[8+i])
        chk = UF.check(formula)
        if chk is not \ok
          ok = false
          $('e'+i).innerHTML = chk

      $(\file).selectedIndex = data[12] * 1
      load_image($(\file).value,
                 ->
                   if ok
                     render!
                     if data[13] then UF.start(canvas)
                 )

  function save_to_hash
    forms = <[c0 c1 c2 c3 c4 c5 c6 c7 f0 f1 f2 f3]>
    params =''
    for i in forms
      params += escape($(forms[i]).value)+":"
    params += $(\file).selectedIndex
    location.hash = params

  function init
    canvas = $(\canvas)
    ctx = canvas.getContext(\2d)
    UF = new UserFilter()

    $(\apply).onclick = ->
      UF.reset_timer()
      if render(true) then save_to_hash!

    $(\start).onclick = ->
      UF.reset_timer!
      if render(true)
        save_to_hash!
        location.hash += ":1"
        UF.start(canvas)

    $(\stop).onclick = ->
      save_to_hash!
      UF.stop!

    $(\popup).onclick = ->
      url = canvas.toDataURL!
      window.open(url)

    $(\setbg).onclick = ->
      document.body.background = canvas.toDataURL!

    ## image selector
    $(\file).onchange = ->
      load_image(@value, save_to_hash)

    for i to 7
      ## slider
      $('c'+i).onchange = ->
        $('m'+@id.substr(1)).value = @value
        if [$(\f0).value,$(\f1).value, $(\f2).value, $(\f3).value].join('').match(/ctl|val|map/)
          render(true)

      ## monitor
      $('m'+i).onchange = ->
        slider = $('c'+@id.substr(1))
        slider.value = isNaN(@value) ? 0 : Math.min(Math.max(Math.round(@value), 0), 255)
        slider.onchange!

    ## formula
    for i to 3
      $('f'+i).onchange = ->
        chk = UF.check(@value)
        $('e'+@id.substr(1)).innerHTML = if chk is \ok then '' else chk

    load_from_hash!

  { init: init }

window.onload = UFJS_DEMO.init
</script>
<script src=https://raw.github.com/satyr/coco/master/extras/coco.js></script>
</body>
</html>
