<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="utf-8">
<style>
body{ width: 100%}
#header, #footer { width: 100%; }
#image { float: left; }
#controler { float: left; }
#formula { clear: both; } 
canvas{ border: solid 2px #000; }
textarea{
  vertical-align: middle;
  font-family: "Courier";
  font-size: 14px;
}
input.ctl { width: 270px }
.caution { 
  color: red;
  font-family: "Courier";
  font-size: 14px;
}
</style>
<title>UserFilter for canvas DEMO</title> 
</head>
<body>
<div id="header">
<h2>UserFilter for canvas DEMO</h1>
</div>
<div id="image">
image:<br>
<br>
<canvas id="canvas" width="256" height="256"></canvas><br>
file:
<select id="file">
<option value="kodim01s.jpg">kodim01</option>
<option value="kodim08s.jpg">kodim08</option>
<option value="kodim22s.jpg">kodim22</option>
<option value="Lenna.jpg">Lenna</option>
<option value="128">blank: 128x128</option>
<option value="256" selected>blank: 256x256</option>
<option value="512">blank: 512x512</option>
</select>
</div>
<form id="panel">
<div id="controler">
controler:
<ol start="0">
  <li><input type="range" id="c0" class="ctl" min="0" max="255" value="0"><input id="m0" type="text" size="3" value="0"></li> 
  <li><input type="range" id="c1" class="ctl" min="0" max="255" value="0"><input id="m1" type="text" size="3" value="0"></li> 
  <li><input type="range" id="c2" class="ctl" min="0" max="255" value="0"><input id="m2" type="text" size="3" value="0"></li>
  <li><input type="range" id="c3" class="ctl" min="0" max="255" value="0"><input id="m3" type="text" size="3" value="0"></li>
  <li><input type="range" id="c4" class="ctl" min="0" max="255" value="0"><input id="m4" type="text" size="3" value="0"></li>
  <li><input type="range" id="c5" class="ctl" min="0" max="255" value="0"><input id="m5" type="text" size="3" value="0"></li>
  <li><input type="range" id="c6" class="ctl" min="0" max="255" value="0"><input id="m6" type="text" size="3" value="0"></li>
  <li><input type="range" id="c7" class="ctl" min="0" max="255" value="0"><input id="m7" type="text" size="3" value="0"></li>
</ol>
</div>
<div id="formula">
<br>
formula:<br>
R<textarea id="f0" cols="80" rows="4">r</textarea><span id="e0" class="caution"></span><br>
G<textarea id="f1" cols="80" rows="4">g</textarea><span id="e1" class="caution"></span><br>
B<textarea id="f2" cols="80" rows="4">b</textarea><span id="e2" class="caution"></span><br>
A<textarea id="f3" cols="80" rows="4">A</textarea><span id="e3" class="caution"></span><br>
<br>
<button id="apply">apply</button> <button id="start">start</button> <button id="stop">stop</button><br>
<button id="popup">to PNG</button>
</div>
<br>
<div id="footer">
<ul type="square">
<li>UserFilter for canvas
<li>version: 0.1
<li>Copyright 2011, Y.Ushiki (<a href="http://twitter.com/Yubeshi/">@Yubeshi</a>, <a href="http://github.com/youz/">github/youz</a>)
<li>released under the MIT license.
<li>reference: <a href="http://gimpuserfilter.sourceforge.net/">UserFilter Plug-in for The Gimp</a>
</ul>
</div>
</form>
<script type="text/javascript">
/*!
 * UserFilter for canvas
 * version: 0.1
 *
 * Copyright 2011, Y.Ushiki
 * released under the MIT license.
 */

var UserFilter = function () {
  // constants
  var rmin = gmin = bmin = amin = cmin = 0;
  var rmax = gmax = bmax = amax = cmax = 255;
  var R = G = B = A = C = 255;
  // var imin = 0, umin = -56, vmin = -78;
  // var imax = 255, umax = 56, vmax = 78;
  var xmin = ymin = mmin = dmin = 0;
  var D = 1024, dmax = 1023;
  var Z = 4, zmin = 0, zmax = 3;

  // canvas size
  var X, xmax, Y, ymax, M, mmax;

  // for animation
  var f = 0, t = 0; // frame counter, elapsed time (msec)

  var flts = new Array(4);
  var ctls = [0, 0, 0, 0, 0, 0, 0, 0];
  var imagedata;

  // filter functions
  function ctl (i) { return ctls[i]; }
  function val (i, a, b) {
    return Math.round(a + ctls[i] * (b-a) / 255);
  }
  function map (i, n) {
    if (n <= ctls[2*i+1]) {
      return 0;
    } else if (n >= ctls[2*i]) {
      return 255;
    } else if (ctls[2*i+1] < n && n < ctls[2*i]) {
      return (n - ctls[2*i+1]) * 255 / (ctls[2*i] - ctls[2*i+1]);
    } else {
      return 0;
    }
  }
  function src (x, y, z) {
    if (x < 0 || x > X || y < 0 || y > Y) return 0;
    return imagedata.data[(x + y * X) * 4 + z];
  }

  function rad (d, m, z) {
    return src(Math.floor(r2x(d, m)), Math.floor(r2y(d, m)), z);
  }

  function _cnv (x, y, z) {
    return function (m11, m12, m13, m21, m22, m23, m31, m32, m33, d) {
      return (m11 * src(x-1, y-1, z) +
	      m12 * src(x, y-1, z) +
	      m13 * src(x+1, y-1, z) +
	      m21 * src(x-1, y, z) +
	      m22 * src(x, y, z) +
	      m23 * src(x+1, y, z) +
	      m31 * src(x-1, y+1, z) +
	      m32 * src(x, y+1, z) +
	      m33 * src(x+1, y+1, z)) / d;
    };
  }

  var min = Math.min;
  var max = Math.max;
  var abs = Math.abs;

  function add (a, b, c) { return min(a + b, c); }
  function dif (a, b)    { return abs(a - b); }
  function sub (a, b, c) { return max(dif(a, b), c); }

  function rnd (a, b) {
    return a + Math.floor(Math.random() * (b - a + 1));
  }

  function mix (a, b, n, d) {
    return d == 0 ? 0 : (a * n + b * (d - n)) / d;
  }

  function scl (a, il, ih, ol, oh) {
    if (a < il) {
      return ol;
    } else if (a > ih) {
      return oh;
    } else if (il == ih) {
      return ol;
    } else {
      return ol + (a - il) * (oh - ol) / (ih - il);
    }
  }

  function sqr (x) {
    return (x < 0) ? 0 : Math.sqrt(x);
  }

  var sintbl = [];
  for (var d = 0; d < 1024; ++d) {
    sintbl[d] = Math.round(Math.sin(Math.PI * d / 512) * 1024);
  }

  function sin (x) {
    return sintbl[x & 1023];
  }
  function cos (x) { return sintbl[(x + 256) & 1023]; }
  function tan (x) {
    var _cos = cos(x);
    return (_cos == 0) ? 0 : 1024 * sintbl[x & 1023] / _cos;
  }

  function r2x (d, m) { return m * cos(d); }
  function r2y (d, m) { return m * sin(d); }

  function c2d (x, y) {
    var dx = x - X/2;
    var dy = Y/2 - y;
    return (Math.atan2(dy, dx) * 512 / Math.PI) & 1023;
  }

  function c2m (x, y) {
    var dx = x - X/2;
    var dy = Y/2 - y;
    return Math.sqrt(dx * dx + dy * dy);
  }

  var temp = new Array(256);
  function put (v, i) {
    if (i < 0 || i > 255) return 0;
    temp[i >> 0] = v;
    return v;
  }

  function get (i) {
    return (i < 0 || i > 255) ? 0 : temp[i];
  }

  // additions
  function rad2d (rad) { return (rad * 512 / Math.PI) & 1023; }
  function deg2d (deg) { return (deg * 1024 / 360) & 1023; }
  var ceil = Math.ceil;
  var floor = Math.floor;
  var log = Math.log;
  var exp = Math.exp;
  var pow = Math.pow;


  // main
  var identifiers = new RegExp('^(' +
			       'R|r|rmin|rmax|G|g|gmin|gmax|B|b|bmin|bmax|A|a|amin|amax|C|c|cmin|cmax|' +
			       'X|x|xmin|xmax|Y|y|ymin|ymax|Z|z|zmin|zmax|D|d|dmin|dmax|M|m|mmin|mmax|' +
			       'ctl|val|map|src|rad|cnv|min|max|abs|add|dif|sub|rnd|mix|scl|sqr|' +
			       'sin|cos|tan|r2x|r2y|c2d|c2m|put|get|rad2d|deg2d|f|t)$');

  function make_func (formula) {
    var tokens = formula.split(/[\s,?:&|=!<>()*%+/~^-]+/);
    for (var i in tokens) {
      if (isNaN(tokens[i]) && !tokens[i].match(identifiers)) {
        throw "ILLEGAL TOKEN: '" + tokens[i] + "'";
      }
    }
    return eval("(function (x,y,m,d,r,g,b,a,c,z) { " +
                (formula.match(/cnv/)?"var cnv = _cnv(x, y, z);":"") +
                " var _; _=" + formula + ";return _; })");
  }

  function apply_filter (canvas) {
    if (typeof flts[0] != "function") {
      return false;
    }

    X = canvas.width;
    Y = canvas.height;
    xmax = X - 1;
    ymax = Y - 1;
    M = Math.floor(c2m(0, 0));
    mmax = M - 1;

    var ctx = canvas.getContext('2d');
    try {
      imagedata = ctx.getImageData(0,0,X,Y);
    } catch (e) {
      window.alert(e);
      return false;
    }
    var data=imagedata.data;

    for (var offset=0, y=0; y < Y; ++y) {
      for (var x=0; x < X; ++x) {
        var m = c2m(x, y);
        var d = c2d(x, y);
        var r = data[offset];
        var g = data[offset+1];
        var b = data[offset+2];
        var a = data[offset+3];
        for (var i=0; i<4; ++i) {
          try {
	    data[offset + i]   = flts[i](x, y, m, d, r, g, b, a, data[offset + i], i);
          } catch (e) {
	    window.alert("Error in formula: " + "RGBA"[i] + "\n" + e);
	    throw e;
          }
        }
        offset += 4;
      }
    }
    ctx.putImageData(imagedata, 0, 0);
    return true;
  }

  // public members
  this.setFormula = function () {
    for (var i=0; i<4; ++i) {
      try {
        flts[i] = make_func(arguments[i]);
      } catch (e) {
        window.alert("Error in formula: " + "RGBA"[i] + "\n" + e);
        return false;
      }
    }
    return true;
  };
  this.controler = ctls;
  this.apply = apply_filter;
  this.check = function (formula) {
      var f;
      try { f = make_func(formula); } catch (e) { return e; }
      return "ok";
  };

  // animation
  var timer;
  this.reset_timer = function () { f = 0; };
  this.start = function (canvas) {
    clearInterval(timer);
    var interval = arguments[1] || 33;
    var start_time = new Date();
    f = 0;
    timer = setInterval(
      function () {
	f++; t = new Date() - start_time;
	if (!apply_filter(canvas)) clearInterval(timer);
      }, interval);
  };
  this.stop = function () {
    clearInterval(timer);
  };

  if (arguments.length == 4) {
    this.setFormula.apply(this, arguments);
  }
};

////////////////////////////////////////////////////////////////////////////////

var UFJS_DEMO = function () {
  var $ = function () {
    return document.getElementById.apply(document, arguments);
  };

  var canvas = $('canvas');
  var ctx = canvas.getContext('2d');
  var UF = new UserFilter();

  function render (reset) {
    UF.setFormula($('f0').value, $('f1').value, $('f2').value, $('f3').value);
    for (var i=0; i<8; ++i) {
      UF.controler[i] = $('c'+i).value * 1;
    }
    if (reset) load_image($('file').value);
    return UF.apply(canvas);
  }

  var images = {};
  function load_image(file, cb) {
    if (!isNaN(file)) {
      var size = file * 1;
      canvas.width = canvas.height = size;
      ctx.putImageData(ctx.createImageData(size, size), 0, 0);
      if (cb) cb();
    } else {
      if (images[file]) {
        canvas.width = images[file].width;
        canvas.height = images[file].height;
        ctx.drawImage(images[file], 0, 0);
        if (cb) cb();
      } else {
        var e = document.createElement('img');
        e.onload = function () {
          images[file] = e;
          canvas.width = e.width;
          canvas.height = e.height;
          ctx.drawImage(e, 0, 0);
          if (cb) cb();
        };
        ctx.save();
        ctx.shadowOffsetX = ctx.shadowOffsetY = ctx.shadowBlur = 1;
        ctx.shadowColor = '#fff';
        ctx.fillText("loading:" + file, 0, 20);
        ctx.restore();
        e.src = file;
      };
    }
  }

  function load_from_hash() {
    if (location.hash != '') {
      var data = location.hash.substr(1).split(/:/);
      if (data.length < 13) return;
      for (var i=0; i<8; ++i) $('c'+i).value = $('m'+i).value = data[i];
      for (i=0; i<4; ++i) $('f'+i).value = decodeURIComponent(data[8+i]);
      $('file').selectedIndex = data[12] * 1;
      load_image($('file').value, function () {
		   render();
		   if (data[13]) UF.start(canvas);
		 });
    }
  }

  function save_to_hash() {
    var forms = ["c0","c1","c2","c3","c4","c5","c6","c7","f0","f1","f2","f3"];
    var params ='';
    for (var i in forms) params += encodeURIComponent($(forms[i]).value)+":";
    params += $('file').selectedIndex;
    location.hash = params;
  }

  // setup handlers
  window.onload = load_from_hash;

  $('apply').onclick = function () {
    UF.reset_timer();
    if (render()) save_to_hash();
  };
  $('start').onclick = function () {
    UF.reset_timer();
    if (render()) {
      save_to_hash();
      location.hash += ":1";
      UF.start(canvas);
    }
  };
  $('stop').onclick = function () {
    save_to_hash();
    UF.stop();
  };
  $('popup').onclick = function () {
    var url = canvas.toDataURL();
    window.open(url);
  };

  // image selector
  $('file').onchange = function () {
    load_image(this.value, save_to_hash);
  };

  for (var i=0; i<8; ++i) {
    // slider
    $('c'+i).onchange = function () {
      $('m'+this.id.substr(1)).value = this.value;
      if ([$('f0').value,$('f1').value, $('f2').value, $('f3').value].join('').match(/ctl|val|map/)) {
        render(true);
      }
    };

    // monitor
    $('m'+i).onchange = function () {
      var slider = $('c'+this.id.substr(1));
      slider.value = isNaN(this.value) ? 0 : Math.min(Math.max(Math.round(this.value), 0), 255);
      slider.onchange();
    };
  }

  // formula
  for (i=0; i<4; ++i) {
    $('f'+i).onchange = function () {
      var chk = UF.check(this.value);
      $('e'+this.id.substr(1)).innerHTML = (chk == 'ok')?'':chk;
    };
  }

  return true;
}();
</script>
